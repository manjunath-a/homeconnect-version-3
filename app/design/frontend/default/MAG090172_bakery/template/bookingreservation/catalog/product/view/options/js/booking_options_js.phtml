<?php
/**
 * Magento
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Academic Free License (AFL 3.0)
 * that is bundled with this package in the file LICENSE_AFL.txt.
 * It is also available through the world-wide-web at this URL:
 * http://opensource.org/licenses/afl-3.0.php
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@magentocommerce.com so we can send you a copy immediately.
 *
 * DISCLAIMER
 *
 * Do not edit or add to this file if you wish to upgrade Magento to newer
 * versions in the future. If you wish to customize Magento for your
 * needs please refer to http://www.magentocommerce.com for more information.
 *
 * @category    design
 * @package     base_default
 * @copyright   Copyright (c) 2011 Magento Inc. (http://www.magentocommerce.com)
 * @license     http://opensource.org/licenses/afl-3.0.php  Academic Free License (AFL 3.0)
 */
?>

<?php

$_product = $this->getProduct();

$Monday_business_hrs_starts = $_product->getMondayBusinessHrsStarts();
$Monday_business_hrs_ends = $_product->getMondayBusinessHrsEnds();

$Tuesday_business_hrs_starts = $_product->getTuesdayBusinessHrsStarts();
$Tuesday_business_hrs_ends = $_product->getTuesdayBusinessHrsEnds();

$Wednesday_business_hrs_starts = $_product->getWednesdayBusinessHrsStarts();
$Wednesday_business_hrs_ends = $_product->getWednesdayBusinessHrsEnds();

$Thursday_business_hrs_starts = $_product->getThursdayBusinessHrsStarts();
$Thursday_business_hrs_ends = $_product->getThursdayBusinessHrsEnds();

$Friday_business_hrs_starts = $_product->getFridayBusinessHrsStarts();
$Friday_business_hrs_ends = $_product->getFridayBusinessHrsEnds();

$Saturday_business_hrs_starts = $_product->getSaturdayBusinessHrsStarts();
$Saturday_business_hrs_ends = $_product->getSaturdayBusinessHrsEnds();

$Sunday_business_hrs_starts = $_product->getSundayBusinessHrsStarts();
$Sunday_business_hrs_ends = $_product->getSundayBusinessHrsEnds();


$current_day_name = date('l');

$bus_start_str = $current_day_name.'_business_hrs_starts';
$bus_end_str = $current_day_name.'_business_hrs_ends';


$bookingStartTime = $$bus_start_str;

$isTodayClosed = '';

if($bookingStartTime == "closed"){
    
    $isTodayClosed = 'yes';    
    
}else{
    
    $start_time_hrs = (int) substr($bookingStartTime,0,2);
    $start_time_minutes = (int) substr($bookingStartTime,3,3);
    $start_daypart = trim(substr($bookingStartTime,5,5));
}



$bookingEndTime = $$bus_end_str;

if($bookingEndTime == "closed"){
    
    $isTodayClosed = 'yes';    
    
}else{

    $end_time_hrs = (int) substr($bookingEndTime,0,2);
    $end_time_minutes = (int) substr($bookingEndTime,3,3);
    $end_daypart = trim(substr($bookingEndTime,5,5));
}


$bookingTimeSlot = (int) $_product->getBookingTimeSlot();

$bufferPeriod = (int) $_product->getBufferPeriod();

$customer_group_id = 0;
$login = Mage::getSingleton('customer/session')->isLoggedIn();
if($login){
    $customer_group_id = Mage::getSingleton('customer/session')->getCustomerGroupId();    
}
$_product->setCustomerGroupId($customer_group_id);

$prod_basic_price = (float) $_product->getPriceModel()->getFinalPrice(1, $_product);

$booking_tire_prices = $_product->getBookingTierPrices();

?>

<span id="is_store_closed_today" style="display:none;"><?php echo $isTodayClosed; ?></span>
    

<p id="sorry_we_are_closed" style="display:none;"><?php echo Mage::helper('bookingreservation')->__('Sorry we are closed.'); ?></p>



<div class="date-time-container" id="fme_date_time_container" style="display:none;">

<?php if(Mage::helper('bookingreservation')->isStaffMembersEnabled()): ?>

    <div class="fme-staff-members">

            <h2><?php echo Mage::helper('bookingreservation')->__('Select Staff Member'); ?></h2>
            
            <div id="fme_staffmembers_area"></div>                   
            
            <div class="clearer"></div>
            
    </div>

<?php endif; ?>


    <div class="date-time-from">
        
        <label style="padding-right:20px;"><?php echo Mage::helper('bookingreservation')->__('From'); ?></label>
        
        <select style="display:none;" class="select" name="fme_booking_time_from[hours-am]" id="fme_booking_time_from-hours-am">
                <?php for($i=$start_time_hrs; $i<12; $i++ ){  ?>
                    <option <?php if($i <= 9): ?>value="<?php echo '0'.$i; ?>"<?php else: ?>value="<?php echo $i; ?>"<?php endif; ?>>
                            <?php if($i <= 9): echo '0'.$i; else: echo $i; endif; ?>
                    </option>
                <?php } ?>
        </select>
        <select style="display:none;" class="select" name="fme_booking_time_from[hours-pm]" id="fme_booking_time_from-hours-pm">
                <option value="12">12</option>
                <?php for($i=1; $i<=$end_time_hrs; $i++ ){  ?>
                    <option <?php if($i <= 9): ?>value="<?php echo '0'.$i; ?>"<?php else: ?> value="<?php echo $i ?>"<?php endif; ?>>
                            <?php if($i <= 9): echo '0'.$i; else: echo $i; endif; ?>
                    </option>
                <?php } ?>
        </select>
        
        
        <select style="width:40px; margin-left:10px;" class="select" name="fme_booking_time_from[hours]" id="fme_booking_time_from-hours">
                
                <?php if($start_daypart == 'am'):?>                
                    <?php for($i=$start_time_hrs; $i<12; $i++ ){  ?>
                        <option <?php if($i <= 9): ?>value="<?php echo '0'.$i ?>"<?php else: ?>value="<?php echo $i ?>"<?php endif; ?>  <?php if($start_time_hrs == $i):?> selected="selected" <?php endif; ?>>
                                <?php if($i <= 9): echo '0'.$i; else: echo $i; endif; ?>
                        </option>
                    <?php } ?>                    
                <?php endif; ?>
                
                <?php if($start_daypart == 'pm'):?>
                    <option value="12">12</option>
                    <?php for($i=1; $i<=$end_time_hrs; $i++ ){  ?>
                        <option <?php if($i <= 9): ?>value="<?php echo '0'.$i ?>"<?php else: ?>value="<?php echo $i ?>"<?php endif; ?> <?php if($start_time_hrs == $i):?> selected="selected" <?php endif; ?>>
                            <?php if($i <= 9): echo '0'.$i; else: echo $i; endif; ?>
                        </option>
                    <?php } ?>
                <?php endif; ?>
                
        </select>
        :
        <select style="width:40px; margin-left:10px; " class="select" name="fme_booking_time_from[minutes]" id="fme_booking_time_from-minutes">
            
            <?php for($i=0; $i<=59; $i++ ){  ?>
                
                <?php if($i <= 9): ?>
                    <option value="<?php echo '0'.$i ?>" <?php if($start_time_minutes == '0'.$i ):?> selected="selected" <?php endif; ?>><?php echo '0'.$i ?></option>
                <?php else: ?>
                    <option value="<?php echo $i ?>" <?php if($start_time_minutes == $i ):?> selected="selected" <?php endif; ?>><?php echo $i ?></option>       
                <?php endif; ?>
                
            <?php  } ?>
            
        </select>
        
        <select style="width:45px; margin-left:10px; " onchange="BookingFromTime.timeSwitchHours(this)" class="select" name="fme_booking_time_from[daypart]" id="fme_booking_time_from-daypart">
            <option value="am" <?php if($start_daypart == 'am'): ?> selected="selected" <?php endif; ?>>AM</option>
            <option value="pm" <?php if($start_daypart == 'pm'): ?> selected="selected" <?php endif; ?>>PM</option>
        </select>
        
    </div>

   <script type="text/javascript">

			BookingFromTime = {
                                
                                timeSwitchHours : function(el){
                                        var isPm = el.selectedIndex; //alert(isPm);
                                            var toShow = ''; 
                                            if(isPm == 0)
                                                toShow = 'fme_booking_time_from-hours-am';
                                            else
                                                toShow = 'fme_booking_time_from-hours-pm';
                                                
                                            $('fme_booking_time_from-hours').options.length = 0;
                                            $A($(toShow).options).each(function(op){
                                                var newOp = new Option(op.text, op.value);
                                                $('fme_booking_time_from-hours')[$('fme_booking_time_from-hours').options.length] = (newOp);
                                            })
                                }, 
                                getMinutes : function(){
					var hours = BookingFromTime.getAbsoluteHours();
					return parseInt(parseInt(hours*60) + parseInt($F('fme_booking_time_from-minutes')));
				},
                                getFixMinutes : function(){
					
					return parseInt($F('fme_booking_time_from-minutes'));
				},
                                getFixHours : function(){
				   var hours = 1*$F($('fme_booking_time_from-hours'))
				   return hours;                                    
				},
				getAbsoluteHours : function(){
				   var hours = 1*$F($('fme_booking_time_from-hours'))
				    if($('fme_booking_time_from-daypart')){
					    if(hours == 12){
						    hours = 0;
					    }
					    if($F($('fme_booking_time_from-daypart')) == 'pm'){
						    hours += 12;
					    }
				    }
				    return hours;
				},
                                getDaypart : function(){
				    return $F('fme_booking_time_from-daypart');
				},                                
				getValueString : function(){
				    return '' + (100+this.getAbsoluteHours()+'').substr(1) + ':' + $F('fme_booking_time_from-minutes') + ':00';
				}
			}
                        
   </script>       
    
    
    
        
    
    <div class="date-time-to">
            
        <label style="padding-right:36px;"><?php echo Mage::helper('bookingreservation')->__('To'); ?></label>
        
        <select style="display:none;" class="select" name="fme_booking_time_to[hours-am]" id="fme_booking_time_to-hours-am">
                <?php for($i=$start_time_hrs; $i<12; $i++ ){  ?>
                    <option <?php if($i <= 9): ?>value="<?php echo '0'.$i; ?>"<?php else: ?>value="<?php echo $i; ?>"<?php endif; ?>>
                            <?php if($i <= 9): echo '0'.$i; else: echo $i; endif; ?>
                    </option>
                <?php } ?>
        </select>
        <select style="display:none;" class="select" name="fme_booking_time_to[hours-pm]" id="fme_booking_time_to-hours-pm">
                <option value="12">12</option>
                <?php for($i=1; $i<=$end_time_hrs; $i++ ){  ?>
                    <option <?php if($i <= 9): ?>value="<?php echo '0'.$i; ?>"<?php else: ?> value="<?php echo $i ?>"<?php endif; ?> >
                            <?php if($i <= 9): echo '0'.$i; else: echo $i; endif; ?>
                    </option>
                <?php } ?>
        </select>
        
        <select style="width:40px; margin-left:10px;" class="select" name="fme_booking_time_to[hours]" id="fme_booking_time_to-hours">               
                    <option value="12">12</option>
                    <?php for($i=1; $i<=$end_time_hrs; $i++ ){  ?>
                        <option <?php if($i <= 9): ?>value="<?php echo '0'.$i ?>"<?php else: ?>value="<?php echo $i ?>"<?php endif; ?>  <?php if($end_time_hrs == $i):?> selected="selected" <?php endif; ?>>
                                <?php if($i <= 9): echo '0'.$i; else: echo $i; endif; ?>
                        </option>
                    <?php } ?>                    
               
        </select>
        :
        <select style="width:40px; margin-left:10px; " class="select" name="fme_booking_time_to[minutes]" id="fme_booking_time_to-minutes">
             <?php for($i=0; $i<=59; $i++ ){  ?>
                
                <?php if($i <= 9): ?>
                    <option value="<?php echo '0'.$i ?>" <?php if($end_time_minutes == '0'.$i ):?> selected="selected" <?php endif; ?>><?php echo '0'.$i ?></option>
                <?php else: ?>
                    <option value="<?php echo $i ?>" <?php if($end_time_minutes == $i ):?> selected="selected" <?php endif; ?>><?php echo $i ?></option>       
                <?php endif; ?>
                
            <?php  } ?>
        </select>
        <select style="width:45px; margin-left:10px; " onchange="BookingToTime.timeSwitchHours(this)" class="select" name="fme_booking_time_to[daypart]" id="fme_booking_time_to-daypart">
            <option value="am" <?php if($end_daypart == 'am'): ?> selected='selected' <?php endif; ?>>AM</option>
            <option value="pm" <?php if($end_daypart == 'pm'): ?> selected='selected' <?php endif; ?>>PM</option>
        </select>
        
    </div>
    
    
    
    <script type="text/javascript">
    
    BookingToTime = {
                                
                                timeSwitchHours : function(el, selected_hour){
                                        var isPm = el.selectedIndex; //alert(isPm);
                                            var toShow = ''; 
                                            if(isPm == 0)
                                                toShow = 'fme_booking_time_to-hours-am';
                                            else
                                                toShow = 'fme_booking_time_to-hours-pm';
                                                
                                            $('fme_booking_time_to-hours').options.length = 0;
                                            $A($(toShow).options).each(function(op){
                                                var newOp = new Option(op.text, op.value);
                                                $('fme_booking_time_to-hours')[$('fme_booking_time_to-hours').options.length] = (newOp);
                                                if(op.value == selected_hour){
                                                    newOp.selected = true;
                                                }
                                            })
                                }, 
                                getMinutes : function(){
					var hours = BookingToTime.getAbsoluteHours();
					return parseInt(parseInt(hours*60) + parseInt($F('fme_booking_time_to-minutes')));
				},
                                getFixMinutes : function(){
					
					return parseInt($F('fme_booking_time_to-minutes'));
				},
                                getFixHours : function(){
				   var hours = 1*$F($('fme_booking_time_to-hours'))
				   return hours;                                    
				},
				getAbsoluteHours : function(){
				   var hours = 1*$F($('fme_booking_time_to-hours'))
				    if($('fme_booking_time_to-daypart')){
					    if(hours == 12){
						    hours = 0;
					    }
					    if($F($('fme_booking_time_to-daypart')) == 'pm'){
						    hours += 12;
					    }
				    }
				    return hours;                                    
				},
                                getDaypart : function(){
				    return $F('fme_booking_time_to-daypart');
				}, 
				getValueString : function(){
				    return '' + (100+this.getAbsoluteHours()+'').substr(1) + ':' + $F('fme_booking_time_to-minutes') + ':00';
				},
                                switchToDefaultTimeSlot : function(){
                                    
                                    //first get the start time Total minutes                                  
                                    var from_hours = BookingFromTime.getFixHours();
                                    var from_min = BookingFromTime.getFixMinutes();
                                    var from_dp = BookingFromTime.getDaypart();
                                    var from_total_min = parseInt(BookingFromTime.getMinutes());                                   
                                    
                                    
                                    var booking_time_slot = parseInt(<?php echo $bookingTimeSlot; ?>);
                                    
                                    
                                    var to_total_min = from_total_min+booking_time_slot;
                                    var to_hours = parseInt(to_total_min/60); //calculate hours
                                    var to_min = parseInt(to_total_min%60); //calculate minutes
                                    var to_dp = 'am';                                    
                                    if(to_hours > 12){
                                        to_dp = 'pm';
                                        to_hours = to_hours - 12;
                                    }
                                    if(to_hours == 12){
                                        to_dp = 'pm';                                        
                                    }
                                    
                                    
                                    if(to_dp=='am'){
                                        $('fme_booking_time_to-daypart').options[0].selected=true;
                                    }
                                    else if(to_dp=='pm'){
                                        $('fme_booking_time_to-daypart').options[1].selected=true;
                                    }
                                    
                                    //switch hourrs for am/pm. 
                                    BookingToTime.timeSwitchHours($('fme_booking_time_to-daypart'));                                    
                                    
                                    
                                    //Keep selected, start time
                                    if($('fme_booking_time_from-minutes')[from_min]){
                                        
                                        $('fme_booking_time_from-minutes')[from_min].selected=true;
                                    }
                                    $A($('fme_booking_time_from-hours').options).each(function(OP){                                            
                                            if(parseNumber(OP.text) == parseNumber(from_hours)){                                               
                                               //alert(OP.value);
                                               OP.selected = true;
                                            }                       
                                    });                                    
                                    
                                    
                                    //Keep selected, start time plus first slot time
                                    if($('fme_booking_time_to-minutes')[to_min]){
                                        
                                        $('fme_booking_time_to-minutes')[to_min].selected=true;
                                    }
                                    $A($('fme_booking_time_to-hours').options).each(function(OP){                                            
                                            if(parseNumber(OP.text) == parseNumber(to_hours)){                                               
                                               //alert(OP.value);
                                               OP.selected = true;
                                            }                       
                                    });
                                    
                                    
                                }
		    }
                        
    </script>       
    
    
    
    
    
    
    <div class="clearer"></div>
    
    
    
    
    
    
    <br /><br />
    
    <h4><?php echo Mage::helper('bookingreservation')->__('Time Schedule') ?></h4>
    <div id="fme_booking_timetable">
	
    </div>

    <table class="fme_booking_identity">
	<tbody>
            <tr>
		<td><div class="identity free"></div><?php echo Mage::helper('bookingreservation')->__('Free time') ?></td>
		<td><div class="identity busy"></div><?php echo Mage::helper('bookingreservation')->__('Busy time') ?></td>
            </tr>
        </tbody>
    </table>
    
    

    <input type="hidden" name="product-booking-price" id="product-booking-price" value="<?php echo $prod_basic_price; ?>" />
    <input type="hidden" name="product-booking-buffer-period" id="product-booking-buffer-period" value="<?php echo $bufferPeriod; ?>" />
    
    
    
    <?php    
    
        $dropdownAttributeObj = $_product->getResource()->getAttribute("booking_type");
        
        $dropdown_option_label = '';
        if ($dropdownAttributeObj->usesSource()) {
	      
	      $dropdown_option_label = $dropdownAttributeObj->getSource()->getOptionText($_product->getData('booking_type'));
                
        }
        
    ?>
    
    
    <?php if($dropdown_option_label == "Mobile Booking"): ?>
    
        <div class="boooking-customer-addresses" >
            <h4><?php echo Mage::helper('bookingreservation')->__('Home Service') ?></h4>
            
            <label style="padding-right:10px;"><?php echo Mage::helper('bookingreservation')->__('Would you like to use service at home') ?></label>
            <select name="fme-use-home-service" name="fme-use-home-service" class="select" >
                <option label="Yes" value="yes"><?php echo Mage::helper('bookingreservation')->__('Yes') ?></option>
                <option label="No" value="no"><?php echo Mage::helper('bookingreservation')->__('No') ?></option>
            </select>            
            <br>
            <label style="padding-right:10px;"><?php echo Mage::helper('bookingreservation')->__('Note : Home service charges will be calculated when you select your address at checkout') ?></label>
            
        </div>
    
    <?php endif; ?>
    
    
</div>










<script type="text/javascript">

                       document.observe("dom:loaded", function() {
                        
                        
                        
                                    //Load business hours of 7 days
                                    TimeDifference.calculateBookingTime(false, true);//minutes_difference, one_slot_selected                            
                                    
                                    $('fme_booking_time_from-hours').observe('change', function(){ TimeDifference.calculateBookingTime() });
                                    $('fme_booking_time_from-minutes').observe('change', function(){ TimeDifference.calculateBookingTime() });
                                    $('fme_booking_time_from-daypart').observe('change', function(){ TimeDifference.calculateBookingTime() });
                                
                                    $('fme_booking_time_to-hours').observe('change', function(){ TimeDifference.calculateBookingTime() });
                                    $('fme_booking_time_to-minutes').observe('change', function(){ TimeDifference.calculateBookingTime() });
                                    $('fme_booking_time_to-daypart').observe('change', function(){ TimeDifference.calculateBookingTime() });
                                     
                                    //this is for configurable products
                                    
                                    $$('.super-attribute-select').each(function(element) {
                                    
                                            element.observe('change', function(){ bookingFilterOptionsPrice() });
                                    
                                    });
                                    
                                    //this is for custom options products
                                    $$('.product-custom-option').each(function(element) {
                                    
                                            element.observe('change', function(){ bookingFilterOptionsPrice() });
                                    
                                    });
                                    
                                    
                       });


                        
                        
                        TimeDifference = {
                            
                            calculateBookingTime : function(minutes_difference, one_slot){
                                
                                if(minutes_difference){
                                    var total_minutes_difference = minutes_difference;
                                }else{
                                    
                                    var total_minutes_difference = Math.abs(BookingFromTime.getMinutes() - BookingToTime.getMinutes());    
                                }
                                
                                var booking_time_slot = <?php echo $bookingTimeSlot; ?>;
                                
                                var selected_slots = Math.ceil(total_minutes_difference/booking_time_slot);
                                
                                var booking_price = <?php echo $prod_basic_price; ?>;
                                
                                if(selected_slots == 0)
                                    { selected_slots = 1; }
                                
                                
                                //if one slot and one slot price, settings enabled
                                <?php if($_product->getIsOneSlotPrice()): ?>
                                    
                                    if(one_slot)
                                        { selected_slots = 1; }
                                        
                                <?php endif; ?>
                                
                                
                                var calculated_price = booking_price*selected_slots;
                                
                                <?php if($booking_tire_prices): ?>
                                    //match with tier prices, otherwise return the given calculated price
                                    calculated_price = bookingTierPrices(total_minutes_difference,calculated_price);
                                <?php endif; ?>
                                
                                optionsPrice.productPrice = calculated_price;                                
                                //$('product-booking-price').value = calculated_price;
                                
                                    opConfig.reloadPrice();
                                    
                                    <?php if($_product->isConfigurable()): ?> // for configurable products
                                    
                                        spConfig.reloadPrice();
                                    
                                    <?php endif; ?>
                                
                                bookingFilterOptionsPrice();
                            }                            
                            
                        }
                        
                    
                    bookingFilterOptionsPrice = function(){
                        
                        if($('product-price-'+<?php echo $_product->getId() ?>+'_clone'))
                            var final_price = $('product-price-'+<?php echo $_product->getId() ?>+'_clone').innerHTML;
                        else
                            var final_price = $('product-price-'+<?php echo $_product->getId() ?>).innerHTML;
                            
                        final_price = final_price.unescapeHTML(); //removes the html
                        final_price = final_price.strip(); //removes the whitespaces
                        final_price = final_price.match(/\d+\.?\d*/g);
                        
                        $('product-booking-price').value = final_price;
                        
                    }
                    
                    CurrentDay = {
                        
                            swithDayHrs : function(day_name){
                                
                                var start_bus_hrs = '';                                
                                
                                var end_bus_hrs = '';
                               
                                
                                if(day_name == 'Monday'){
                                    
                                    start_bus_hrs = <?php echo '"'.$Monday_business_hrs_starts.'"'; ?>;
                                    end_bus_hrs = <?php echo '"'.$Monday_business_hrs_ends.'"'; ?>;
                                }else
                                if(day_name == 'Tuesday'){
                                    
                                    start_bus_hrs = <?php echo '"'.$Tuesday_business_hrs_starts.'"'; ?>;
                                    end_bus_hrs = <?php echo '"'.$Tuesday_business_hrs_ends.'"'; ?>;                                    
                                }else
                                if(day_name == 'Wednesday'){
                                    
                                    start_bus_hrs = <?php echo '"'.$Wednesday_business_hrs_starts.'"'; ?>;
                                    end_bus_hrs = <?php echo '"'.$Wednesday_business_hrs_ends.'"'; ?>;                                    
                                }else
                                if(day_name == 'Thursday'){
                                    
                                    start_bus_hrs = <?php echo '"'.$Thursday_business_hrs_starts.'"'; ?>;
                                    end_bus_hrs = <?php echo '"'.$Thursday_business_hrs_ends.'"'; ?>;                                    
                                }else
                                if(day_name == 'Friday'){
                                    
                                    start_bus_hrs = <?php echo '"'.$Friday_business_hrs_starts.'"'; ?>;
                                    end_bus_hrs = <?php echo '"'.$Friday_business_hrs_ends.'"'; ?>;                                    
                                }else
                                if(day_name == 'Saturday'){
                                    
                                    start_bus_hrs = <?php echo '"'.$Saturday_business_hrs_starts.'"'; ?>;
                                    end_bus_hrs = <?php echo '"'.$Saturday_business_hrs_ends.'"'; ?>;                                    
                                }else
                                if(day_name == 'Sunday'){
                                    
                                    start_bus_hrs = <?php echo '"'.$Sunday_business_hrs_starts.'"'; ?>;
                                    end_bus_hrs = <?php echo '"'.$Sunday_business_hrs_ends.'"'; ?>;                                    
                                }
                                
                                var booking_from = new Array();                                
                                booking_from['hrs'] = start_bus_hrs.substring(0,2);
                                booking_from['min'] = start_bus_hrs.substring(3,5);
                                booking_from['daypart'] = start_bus_hrs.substring(6,8);
                                
                                var booking_to = new Array();
                                booking_to['hrs'] = end_bus_hrs.substring(0,2);
                                booking_to['min'] = end_bus_hrs.substring(3,5);
                                booking_to['daypart'] = end_bus_hrs.substring(6,8);
                                
                                setProductDayBusinessHrs(booking_from,booking_to);
                                
                            }                    
                        
                        
                    }
                
                
                MemberCurrentDay = {
                        
                            swithDayHrs : function(){
                                
                                var start_bus_hrs = '';                               
                                var end_bus_hrs = '';
                               
                                
                                    var url  = '<?php echo $this->getUrl('bookingreservation/index/getMembersAvailableTime') ?>';
                                    var current_member = Form.getInputs('product_addtocart_form','radio','booking_staff_members').find(function(radio) { return radio.checked; }).value;
                            
                                    var date = new Date(converToIE8LessDate($F('fme_calendar_date')));
                                    
                                    var test_date = new Date(converToIE8LessDate('2013-07-08')); //This is Monday
                                    if(test_date.getDay() == 0){ //Monday is the first day
                                        var current_day = Calendar.DAY_NAMES[date.getDay()+1];    
                                    }else{ //Sunday is the first day
                                        var current_day = Calendar.DAY_NAMES[date.getDay()];
                                    }
                                    
                                    //var current_day = Calendar.DAY_NAMES[date.getDay()];                   
                                    
                                    if(current_member != 0){
                                        
                                                new Ajax.Request(url,{
                                                    
                                                    method: 'post',
                                                    dataType: "json",
                                                    parameters : {selected_day:current_day,selected_member:current_member},
                                                    onLoading: function(){
                                                        
                                                        $('fme_booking_timetable').update('<span>Loading wait ...</span>');
                                                        
                                                    },
                                                    onSuccess: function(transport) {
                                                        
                                                        var member_timing       = transport.responseText.evalJSON();
                                                        var start_bus_hrs   = member_timing['member_start_time'];
                                                        var end_bus_hrs     = member_timing['member_end_time'];
                                            
                                             
                                                        var booking_from = new Array();                                
                                                        booking_from['hrs'] = start_bus_hrs.substring(0,2);
                                                        booking_from['min'] = start_bus_hrs.substring(3,5);
                                                        booking_from['daypart'] = start_bus_hrs.substring(6,8);
                                                        
                                                        var booking_to = new Array();
                                                        booking_to['hrs'] = end_bus_hrs.substring(0,2);
                                                        booking_to['min'] = end_bus_hrs.substring(3,5);
                                                        booking_to['daypart'] = end_bus_hrs.substring(6,8);
                                                        
                                                        
                                                        
                                                        setProductDayBusinessHrs(booking_from,booking_to);
                                                    }
                                                });
                                    }else{
                                        
                                        CurrentDay.swithDayHrs(current_day);
                                    }
                                
                                
                            }                    
                        
                        
                    }
                    
                    
                    
                
                setProductDayBusinessHrs = function(from_array, to_array){
                    
                    // these options are for Start Booking Time
                    
                    $("fme_booking_time_from-hours-am").options.length = 0;                    
                    for(var i=parseNumber(from_array['hrs']); i<12; i++ ){
                    
                                if(i<=9) var newOp = new Option('0'+i, '0'+i);
                                else    var newOp = new Option(i, i);
                                
                                $("fme_booking_time_from-hours-am")[$("fme_booking_time_from-hours-am").options.length] = (newOp);
                    }
                    
                    
                    $("fme_booking_time_from-hours-pm").options.length = 0;
                    $("fme_booking_time_from-hours-pm")[$("fme_booking_time_from-hours-pm").options.length] = (new Option(12, 12));
                    for(var i=1; i<=parseNumber(to_array['hrs']); i++ ){
                    
                                if(i<=9) var newOp = new Option('0'+i, '0'+i);
                                else    var newOp = new Option(i, i);
                                
                                $("fme_booking_time_from-hours-pm")[$("fme_booking_time_from-hours-pm").options.length] = (newOp);
                    }
                    
                    
                    
                    $("fme_booking_time_from-hours").options.length = 0;
                    if(from_array['daypart'] == 'am'){
                            for(var i=parseNumber(from_array['hrs']); i<12; i++ ){
                                        
                                        if(i<=9) var newOp = new Option('0'+i, '0'+i);
                                        else    var newOp = new Option(i, i);
                                        
                                        $("fme_booking_time_from-hours")[$("fme_booking_time_from-hours").options.length] = (newOp);
                            }                        
                    }
                    
                    if(from_array['daypart'] == 'pm'){
                            $("fme_booking_time_from-hours")[$("fme_booking_time_from-hours").options.length] = (new Option(12, 12));
                            for(var i=1; i<=parseNumber(to_array['hrs']); i++ ){
                    
                                        if(i<=9) var newOp = new Option('0'+i, '0'+i);
                                        else    var newOp = new Option(i, i);
                                        
                                        $("fme_booking_time_from-hours")[$("fme_booking_time_from-hours").options.length] = (newOp);
                            }
                    }
                    
                    if($('fme_booking_time_from-hours')[parseNumber(from_array['hrs'])]){ $('fme_booking_time_from-hours')[parseNumber(from_array['hrs'])].selected=true;   }
                    if($('fme_booking_time_from-minutes')[from_array['min']])    $('fme_booking_time_from-minutes')[from_array['min']].selected=true;
                    
                    if(from_array['daypart']=='am')
                        $('fme_booking_time_from-daypart').options[0].selected=true;
                    else if(from_array['daypart']=='pm')
                        $('fme_booking_time_from-daypart').options[1].selected=true;
                    
                    
                    // these options are for End Booking Time
                    
                    $("fme_booking_time_to-hours-am").options.length = 0;                    
                    for(var i=parseNumber(from_array['hrs']); i<12; i++ ){
                    
                                if(i<=9) var newOp = new Option('0'+i, '0'+i);
                                else    var newOp = new Option(i, i);
                                
                                $("fme_booking_time_to-hours-am")[$("fme_booking_time_to-hours-am").options.length] = (newOp);
                    }
                    
                    
                    $("fme_booking_time_to-hours-pm").options.length = 0;
                    $("fme_booking_time_to-hours-pm")[$("fme_booking_time_to-hours-pm").options.length] = (new Option(12, 12));
                    for(var i=1; i<=parseNumber(to_array['hrs']); i++ ){
                    
                                if(i<=9) var newOp = new Option('0'+i, '0'+i);
                                else    var newOp = new Option(i, i);
                                
                                $("fme_booking_time_to-hours-pm")[$("fme_booking_time_to-hours-pm").options.length] = (newOp);
                    }
                    
                    $("fme_booking_time_to-hours").options.length = 0;
                    if(to_array['daypart'] == 'am'){
                        
                            if(to_array['hrs'] == 12){
                                $("fme_booking_time_to-hours")[$("fme_booking_time_to-hours").options.length] = (new Option(12, 12));
                            }
                            for(var i=parseNumber(to_array['hrs']); i<12; i++ ){
                    
                                        if(i<=9) var newOp = new Option('0'+i, '0'+i);
                                        else    var newOp = new Option(i, i);
                                        
                                        $("fme_booking_time_to-hours")[$("fme_booking_time_to-hours").options.length] = (newOp);
                            }                        
                    }
                    
                    if(to_array['daypart'] == 'pm'){
                            $("fme_booking_time_to-hours")[$("fme_booking_time_to-hours").options.length] = (new Option(12, 12));
                            for(var i=1; i<=parseNumber(to_array['hrs']); i++ ){
                    
                                        if(i<=9) var newOp = new Option('0'+i, '0'+i);
                                        else    var newOp = new Option(i, i);
                                        
                                        $("fme_booking_time_to-hours")[$("fme_booking_time_to-hours").options.length] = (newOp);
                            }
                    }
                    
                   
                    
                    if($('fme_booking_time_to-hours')[parseNumber(to_array['hrs'])]){ $('fme_booking_time_to-hours')[parseNumber(to_array['hrs'])].selected=true;   }
                    if($('fme_booking_time_to-minutes')[to_array['min']]){      $('fme_booking_time_to-minutes')[to_array['min']].selected=true;  }
                    
                    if(to_array['daypart']=='am')
                        $('fme_booking_time_to-daypart').options[0].selected=true;
                    else if(to_array['daypart']=='pm')
                        $('fme_booking_time_to-daypart').options[1].selected=true;
                    
                }
                
                
                
                getBookingBusyTime = function(current_day,current_product,current_store){
                    
                    var url  = '<?php echo $this->getUrl('bookingreservation/index/getBookingInfo') ?>';
                    //var current_member = Form.getInputs('product_addtocart_form','radio','booking_staff_members').find(function(radio) { return radio.checked; }).value;
            
                    
                    
                    new Ajax.Request(url,{
                        
                        method: 'post',
                        dataType: "json",
                        parameters : {selected_day:current_day,selected_product:current_product,selected_store:current_store,selected_member:0},
                        onLoading: function(){
                            
                            $('fme_booking_timetable').update('<span>Loading wait ...</span>');
                            
                        },
                        onSuccess: function(transport) {
                            
                           //alert(transport.responseText);                           
                           //alert(BookingFromTime.getDaypart());
                           
                            Timetable.setup({
                                
                                timeSlot : <?php echo $bookingTimeSlot; ?>,
                                startBusinessHrs : BookingFromTime.getFixHours(),
                                startBusinessMin : BookingFromTime.getMinutes(),
                                startBusinessDaypart : BookingFromTime.getDaypart(),
                                srartBusinessFixMinutes : BookingFromTime.getFixMinutes(),
                                
                                selectedCalendarDay : $F('fme_calendar_date'),
                                reservedTimeOfTheDay : transport.responseText.evalJSON(),
                                
                                endBusinessHrs : BookingToTime.getFixHours(),
                                endBusinessMin : BookingToTime.getMinutes(),
                                endBusinessDaypart : BookingToTime.getDaypart(),
                                endBusinessFixMinutes : BookingToTime.getFixMinutes()
                                
                            });
                            
                            
                        },
                        onComplete: function(){
                            
                            //if one slot and one slot price, settings enabled                            
                            <?php if($_product->getIsOneSlotPrice()): ?>
                                
                                BookingToTime.switchToDefaultTimeSlot();
                                
                            <?php endif; ?>
                            
                        },
                        onFailure: function(transport) {
                            
                            alert('Failed to get booking info');
                            
                        } 
                        
                        
                        
                        
                    });
                    
                    
                }
                
                
                
                
                
</script>





<script type="text/javascript">
    //<![CDATA[
           
          
           
           Event.observe(window, 'load', function() {                
               
                checkOnloadStoreIsClosed();
                
                
           });




        //////////////////////////////////////////////////////////////////////////////////////////
        
        checkCalenderClickStoreIsClosed = function(){
                    
                    var url  = '<?php echo $this->getUrl('bookingreservation/index/getCurrentDayStoreOpen') ?>';
                    
                    var date = new Date(converToIE8LessDate($F('fme_calendar_date')));
                    
                    //alert(date);
                    
                    
                    var test_date = new Date(converToIE8LessDate('2013-07-08')); //This is Monday
                    if(test_date.getDay() == 0){ //Monday is the first day
                        var current_day = Calendar.DAY_NAMES[date.getDay()+1];    
                    }else{ //Sunday is the first day
                        var current_day = Calendar.DAY_NAMES[date.getDay()];
                    }
                    //var current_day = Calendar.DAY_NAMES[date.getDay()];                   
                    
                    new Ajax.Request(url,{
                        
                        method: 'post',                        
                        parameters : {product_id:<?php echo $_product->getId(); ?>,dayname:current_day},
                        onLoading: function(){
                            
                            createWaitingOverLay();
                            
                        },
                        onSuccess: function(transport) { 
                           
                            if(transport.responseText == 'open'){ // if store is open
                            
                                $('fme_date_time_container').setStyle('display:block');
                                $('sorry_we_are_closed').setStyle('display:none');
                                
                                <?php if(Mage::helper('bookingreservation')->isStaffMembersEnabled()): ?>
                                //load staff members
                                getAvailableMembers();
                                <?php endif; ?>
                                
                                
                                // show the time schedule after getting busy time of selected day of calender
                                getBookingBusyTime($F('fme_calendar_date'),<?php echo $_product->getId() ?>,<?php echo Mage::app()->getStore()->getStoreId() ?>);                   
                                
                                $$('.product-options-bottom').each(function(c){
                                    c.setStyle('display:block');
                                });
                                
                                
                                
                            }else{ // store is closed yes
                                
                                $('fme_date_time_container').setStyle('display:none');
                                $('sorry_we_are_closed').setStyle('display:block');
                                
                                $$('.product-options-bottom').each(function(c){
                                    c.setStyle('display:none');
                                });
                                //$('.product-options-bottom').setStyle('display:none');
                            }                       
                            
                        },
                        onComplete: function(){
                            
                           removeWaitingOverLay();
                           
                        },
                        onFailure: function(transport) {
                            
                            alert('Failed to get Calender day close info');
                            
                        }                      
                        
                        
                    });
                    
                }
            
            
            
            /////////////////////////////////////////////////////////////////////////////////////
            
            checkOnloadStoreIsClosed = function(){
                    
                    var url  = '<?php echo $this->getUrl('bookingreservation/index/getCurrentDayStoreOpen') ?>';
                    
                    var date = new Date(converToIE8LessDate($F('fme_calendar_date')));
                    
                    var test_date = new Date(converToIE8LessDate('2013-07-08')); //This is Monday
                    if(test_date.getDay() == 0){ //Monday is the first day
                        var current_day = Calendar.DAY_NAMES[date.getDay()+1];    
                    }else{ //Sunday is the first day
                        var current_day = Calendar.DAY_NAMES[date.getDay()];
                    }
                    //var current_day = Calendar.DAY_NAMES[date.getDay()];                   
                    
                    new Ajax.Request(url,{
                        
                        method: 'post',                        
                        parameters : {product_id:<?php echo $_product->getId(); ?>,dayname:current_day},
                        onLoading: function(){
                            
                            createWaitingOverLay();
                            
                        },
                        onSuccess: function(transport) {                            
                           
                           
                            if(transport.responseText == 'open'){ // if store is open   
                    
                                $('fme_date_time_container').setStyle('display:block');
                                $('sorry_we_are_closed').setStyle('display:none');
                                
                                <?php if(Mage::helper('bookingreservation')->isStaffMembersEnabled()): ?>
                                //load staff members
                                getAvailableMembers();
                                <?php endif; ?>
                                
                                Form.reset('product_addtocart_form');
                                // show the time schedule after getting busy time of current day
                                getBookingBusyTime($F('fme_calendar_date'),<?php echo $_product->getId() ?>,<?php echo Mage::app()->getStore()->getStoreId() ?>);
                                
                                $$('.product-options-bottom').each(function(c){
                                    c.setStyle('display:block');
                                });
                                
                                
                                
                            }else{ // store is closed yes
                                
                                $('fme_date_time_container').setStyle('display:none');
                                $('sorry_we_are_closed').setStyle('display:block');
                                
                                $$('.product-options-bottom').each(function(c){
                                    c.setStyle('display:none');
                                });
                            }                      
                            
                        },
                        onComplete: function(){
                            
                            removeWaitingOverLay();
                            
                        },
                        onFailure: function(transport) {
                            
                            alert('Failed to get Calender day close info');
                            
                        }                      
                        
                        
                    });
                    
                }
                
                
                
            /////////////////////////////////////////////////////////////////////////////////////
            
                
                
            getMemberAvailabilityTime = function(){
                    
                    var url  = '<?php echo $this->getUrl('bookingreservation/index/getMembersAvailableTime') ?>';
                    var current_member = Form.getInputs('product_addtocart_form','radio','booking_staff_members').find(function(radio) { return radio.checked; }).value;
            
                    var date = new Date(converToIE8LessDate($F('fme_calendar_date')));
                    
                    var test_date = new Date(converToIE8LessDate('2013-07-08')); //This is Monday
                    if(test_date.getDay() == 0){ //Monday is the first day
                        var current_day = Calendar.DAY_NAMES[date.getDay()+1];    
                    }else{ //Sunday is the first day
                        var current_day = Calendar.DAY_NAMES[date.getDay()];
                    }                    
                    //var current_day = Calendar.DAY_NAMES[date.getDay()];                   
                    
                    if(current_member != 0){
                        
                                new Ajax.Request(url,{
                                    
                                    method: 'post',
                                    dataType: "json",
                                    parameters : {selected_day:current_day,selected_member:current_member},
                                    onLoading: function(){
                                        
                                        $('fme_booking_timetable').update('<span>Loading wait ...</span>');
                                        
                                    },
                                    onSuccess: function(transport) {
                                        
                                        var member_timing       = transport.responseText.evalJSON();
                                        var member_start_time   = member_timing['member_start_time'];
                                        var member_end_time     = member_timing['member_end_time'];
                                        
                                        if(member_start_time != 'closed' && member_end_time != 'closed'){
                                            
                                            var member_start_time_hr    =   member_start_time.substring(0,2);
                                            var member_start_time_min   =   member_start_time.substring(3,5);
                                            var member_start_time_dp    =   member_start_time.substring(6,8);
                                            
                                            var member_end_time_hr      =   member_end_time.substring(0,2);
                                            var member_end_time_min     =   member_end_time.substring(3,5);
                                            var member_end_time_dp      =   member_end_time.substring(6,8);
                                            
                                            
                                            getMemberBusyTime(member_start_time_hr,member_start_time_min,member_start_time_dp,member_end_time_hr,member_end_time_min,member_end_time_dp);
                                        
                                        }else{
                                            
                                            $('fme_booking_timetable').update('<span>Member is off</span>');
                                        }
                                        
                                        
                                        
                                    },
                                    onComplete: function(){
                                        
                                        //disableProgressLoader();  
                                    },
                                    onFailure: function(transport) {
                                        
                                        alert('Failed to get booking info');
                                        
                                    }
                        
                        
                                });
                    }else{
                        
                        getBookingBusyTime($F('fme_calendar_date'),<?php echo $_product->getId() ?>,<?php echo Mage::app()->getStore()->getStoreId() ?>);
                        TimeDifference.calculateBookingTime();
                    }
                    
                    
            }
            
            
            
            
            
            getMemberBusyTime = function(start_hrs,start_min,start_dp,end_hrs,end_min,end_dp){
                    
                    
                    var url  = '<?php echo $this->getUrl('bookingreservation/index/getBookingInfo') ?>';
                    var current_member = Form.getInputs('product_addtocart_form','radio','booking_staff_members').find(function(radio) { return radio.checked; }).value;
                    var current_day = $F('fme_calendar_date');                                            
                    var current_product = <?php echo $_product->getId() ?>;
                    var current_store = <?php echo Mage::app()->getStore()->getStoreId() ?>;
                    
                    
                    new Ajax.Request(url,{
                        
                        method: 'post',
                        dataType: "json",
                        parameters : {selected_day:current_day,selected_product:current_product,selected_store:current_store,selected_member:current_member},
                        onLoading: function(){
                            
                            $('fme_booking_timetable').update('<span>Loading wait ...</span>');
                            
                        },
                        onSuccess: function(transport) {
                            
                           //alert(transport.responseText);
                            
                           
                            Timetable.setup({
                                
                                timeSlot : <?php echo $bookingTimeSlot; ?>,
                                startBusinessHrs : start_hrs,                                
                                startBusinessDaypart : start_dp,
                                srartBusinessFixMinutes : parseInt(start_min),
                                startBusinessMin : MembersTime.getMinutes(start_hrs,parseInt(start_min),start_dp),
                                
                                selectedCalendarDay : $F('fme_calendar_date'),
                                reservedTimeOfTheDay : transport.responseText.evalJSON(),
                                
                                endBusinessHrs : end_hrs,                                
                                endBusinessDaypart : end_dp,
                                endBusinessFixMinutes : parseInt(end_min),
                                endBusinessMin : MembersTime.getMinutes(end_hrs,parseInt(end_min),end_dp)
                                
                            });
                            
                            
                            
                        },
                        onComplete: function(){
                            
                            TimeDifference.calculateBookingTime(Math.abs( MembersTime.getMinutes(start_hrs,parseInt(start_min),start_dp) - MembersTime.getMinutes(parseInt(end_hrs),parseInt(end_min),end_dp)), true);
                            
                            <?php if($_product->getIsOneSlotPrice()): ?>
                                
                                BookingToTime.switchToDefaultTimeSlot();
                                
                            <?php endif; ?>
                        },
                        onFailure: function(transport) {
                            
                            alert('Failed to get booking info');
                            
                        } 
                        
                        
                        
                        
                    });
                    
                    
            }
            
        
        
        
        getAvailableMembers = function(){
                    
                    
                    var url  = '<?php echo $this->getUrl('bookingreservation/index/getAvailableMembers') ?>';
                    
                    var date = new Date(converToIE8LessDate($F('fme_calendar_date')));
                    
                    var test_date = new Date(converToIE8LessDate('2013-07-08')); //This is Monday
                    if(test_date.getDay() == 0){ //Monday is the first day
                        var current_day = Calendar.DAY_NAMES[date.getDay()+1];    
                    }else{ //Sunday is the first day
                        var current_day = Calendar.DAY_NAMES[date.getDay()];
                    }
                    
                    //var current_day = Calendar.DAY_NAMES[date.getDay()];  
                    var current_product = <?php echo $_product->getId() ?>;
                    
                    
                    
                    new Ajax.Request(url,{
                        
                        method: 'post',                        
                        parameters : {selected_day_name:current_day,selected_product:current_product},
                        onLoading: function(){
                            
                            $('fme_staffmembers_area').update('<span>Loading wait ...</span>');
                            
                        },
                        onSuccess: function(transport) {
                            
                           //alert(transport.responseText);
                           $('fme_staffmembers_area').update(transport.responseText); 
                            
                        },
                        onComplete: function(){
                            
                            Form.getInputs('product_addtocart_form','radio','booking_staff_members').find(function(radio){
                                    
                                    if(IE8d){ // for IE<=8 to obserce click event, rather then change event
                                        
                                        Event.observe(radio, 'click', function() {                                           
                                            MemberCurrentDay.swithDayHrs();
                                            getMemberAvailabilityTime();
                                        });                                        
                                        
                                    }else{
                                        
                                        Event.observe(radio, 'change', function() {                                           
                                            MemberCurrentDay.swithDayHrs();
                                            getMemberAvailabilityTime();
                                        });    
                                    }
                                                    
                            });
                            
                        },
                        onFailure: function(transport) {
                            
                            alert('Failed to get booking info');
                            
                        } 
                        
                    });
                    
                    
            }    
           
        MembersTime = {
                                
                                getMinutes : function(m_hrs, m_min, m_dp){
                                        //alert(parseNumber(m_hrs));
					var hours = MembersTime.getAbsoluteHours(parseNumber(m_hrs),m_dp);                                        
					return parseInt(parseInt(hours*60) + parseInt(m_min));
				},
                                getAbsoluteHours : function(m_hrs,m_dp){
                                    
				   var hours = 1*m_hrs;
				    if(m_dp){
					    if(hours == 12){
						    hours = 0;
					    }
					    if(m_dp == 'pm'){
						    hours += 12;
					    }
				    }
				    return hours;
				}
        }
            
            
            
           //create overlay and append to given element
        function createWaitingOverLay(){
            
            
            $$('body')[0].insert(new Element("div",{id:"fme-overlay"}));
            
        }
        
        //removes overlay
        function removeWaitingOverLay(){
            
            if($('fme-overlay') != null) {
                
                $('fme-overlay').remove();  
            }            
        }
            
        
        function converToIE8LessDate(dateStr){
            
            //var dateStr = "2011-08-03" returned form
            
            if(IE8d){
                
                var d = dateStr.split("-");            
                var dateStr = new Date(d[0],(d[1]-1),d[2]);
            }
            
            
            return dateStr;
        }
    //]]>
</script>


